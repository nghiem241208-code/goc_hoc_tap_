<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>L∆∞u tr·ªØ S∆° ƒë·ªì t∆∞ duy ‚Äî L∆∞·ªõi √¥</title>
<style>
  :root{
    --bg:#0e1726; --card:#1a2333; --accent:#00b4d8; --accent2:#ff9f43;
    --text:#e6eef8; --muted:#b7c8e1;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter, "Poppins", sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:28px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
  header h1{font-size:1.3rem;color:var(--accent)}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  button, .filebtn{background:var(--accent2);border:none;color:#08111a;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px}
  .container{max-width:1200px;margin:0 auto}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px}
  .box{
    background:var(--card);border-radius:14px;padding:12px;position:relative;min-height:220px;
    display:flex;flex-direction:column;gap:8px;box-shadow:0 8px 24px rgba(0,0,0,0.5)
  }
  .box .top{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .thumb{height:120px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);display:flex;align-items:center;justify-content:center;overflow:hidden}
  .thumb img{max-width:100%;max-height:100%;object-fit:contain}
  .note{flex:1;min-height:46px;padding:8px;border-radius:8px;background:rgba(0,0,0,0.08);color:var(--text);outline:none}
  .box .actions{display:flex;gap:8px;margin-top:6px;align-items:center;flex-wrap: wrap;}
  .small{padding:6px 8px;font-size:13px;border-radius:8px}
  .remove{position:absolute;top:10px;right:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:6px;border-radius:8px;cursor:pointer;color:var(--muted)}
  .empty{color:var(--muted);font-size:0.95rem;text-align:center;padding:18px}
  footer{max-width:1200px;margin:18px auto 0;color:var(--muted);font-size:13px;text-align:center}
  input[type=file]{display:none}
  .flex{display:flex;gap:8px;align-items:center}
  .import-input{display:none}
  .topbar-left{display:flex;gap:12px;align-items:center}
  .btn-primary{background:var(--accent);color:#08111a;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  @media (max-width:520px){ header{flex-direction:column;align-items:flex-start} .controls{width:100%;justify-content:flex-start} }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="topbar-left">
        <h1>Kho S∆° ƒë·ªì t∆∞ duy ‚Äî </h1>
        <div style="color:var(--muted);font-size:13px">M·ªói √¥: ·∫¢nh + Ghi ch√∫ </div>
      </div>
      <div class="controls">
        <button id="add-box" class="btn-primary">‚ûï Th√™m √¥</button>
        <button id="export-all" class="ghost">‚¨á Xu·∫•t </button>
        <label class="ghost" style="cursor:pointer;padding:7px 10px;border-radius:8px">
          ‚¨Ü Nh·∫≠p 
          <input id="import-file" class="import-input" type="file" accept=".json">
        </label>
        <button id="clear-all" class="ghost">üóë X√≥a t·∫•t c·∫£</button>
      </div>
    </header>

    <main>
      <div id="grid" class="grid" aria-live="polite"></div>
      <div id="empty-msg" class="empty" style="display:none">Ch∆∞a c√≥ √¥ n√†o ‚Äî b·∫•m "Th√™m √¥" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>
    </main>

    <footer>
     
    </footer>
  </div>

<script>
(function(){
  const KEY = 'mindmap_grid_v1';
  const grid = document.getElementById('grid');
  const emptyMsg = document.getElementById('empty-msg');

  function uid(){ return 'id'+Math.random().toString(36).slice(2,9); }

  // Escape html
  function escapeHtml(s){ 
    return s.replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;'); 
  }
  
  // H√†m m·ªõi: Chuy·ªÉn ƒë·ªïi Base64 th√†nh Blob ƒë·ªÉ t·∫°o Object URL ng·∫Øn (kh·∫Øc ph·ª•c l·ªói URL d√†i)
  function base64ToBlob(base64) {
    const parts = base64.split(';base64,');
    if (parts.length < 2) throw new Error("D·ªØ li·ªáu Base64 kh√¥ng h·ª£p l·ªá.");

    const contentType = parts[0].split(':')[1];
    const raw = window.atob(parts[1]);
    const rawLength = raw.length;
    const uInt8Array = new Uint8Array(rawLength);

    for (let i = 0; i < rawLength; ++i) {
      uInt8Array[i] = raw.charCodeAt(i);
    }
    return new Blob([uInt8Array], { type: contentType });
  }

  // Load + Save
  function load(){
    try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch{ return []; }
  }
  function localSave(data){ localStorage.setItem(KEY, JSON.stringify(data)); }
  function save(data){ localSave(data); renderAll(); }

  // Render each box
  function renderBox(item){
    const div = document.createElement('div');
    div.className='box';
    div.dataset.id = item.id;

    div.innerHTML = `
      <button class="remove" title="X√≥a √¥ (nhanh)">‚úñ</button>
      <div class="top">
        <div class="flex">
          <label class="filebtn small" style="display:inline-block;cursor:pointer">üìÅ Ch·ªçn ·∫£nh
            <input type="file" accept="image/*" style="display:none" class="img-input">
          </label>
          <div style="font-size:13px;color:var(--muted);padding-left:6px">${item.title || 'Kh√¥ng t√™n'}</div>
        </div>
        <div style="font-size:12px;color:var(--muted)">${item.date || ''}</div>
      </div>

      <div class="thumb">
        ${ 
          item.img 
          ? `<img src="${item.img}" alt="thumb" style="cursor: pointer;" title="D√πng n√∫t 'M·ªü ·∫£nh' b√™n d∆∞·ªõi ƒë·ªÉ xem.">`
          : `<div style="color:var(--muted);padding:8px">Ch∆∞a c√≥ ·∫£nh</div>` 
        }
      </div>

      <div contenteditable="true" class="note">${escapeHtml(item.note || '')}</div>

      <div class="actions">
        <button class="small btn-save">L∆∞u</button>
        <button class="small ghost btn-open-img">üñº M·ªü ·∫£nh</button>
        <button class="small ghost btn-remove-img">X√≥a ·∫£nh</button>
        <button class="small ghost btn-delete-box">X√≥a √¥</button>
      </div>
    `;

    // Elements
    const removeBtn   = div.querySelector('.remove');
    const fileInput   = div.querySelector('.img-input');
    const thumb       = div.querySelector('.thumb');
    const note        = div.querySelector('.note');
    const btnSave     = div.querySelector('.btn-save');
    const btnOpenImg  = div.querySelector('.btn-open-img');
    const btnRemoveImg= div.querySelector('.btn-remove-img');
    const btnDeleteBox= div.querySelector('.btn-delete-box');

    // Remove box (fast)
    removeBtn.onclick = () => {
      if(!confirm('X√≥a √¥ n√†y?')) return;
      const data = load();
      const idx = data.findIndex(x=>x.id===item.id);
      if(idx>-1){ data.splice(idx,1); save(data); toast('ƒê√£ x√≥a √¥'); }
    };

    // Remove box (action row)
    btnDeleteBox.onclick = () => {
      if(!confirm('X√≥a √¥ n√†y?')) return;
      const data = load();
      const idx = data.findIndex(x=>x.id===item.id);
      if(idx>-1){ data.splice(idx,1); save(data); toast('ƒê√£ x√≥a √¥'); }
    };

    // Upload image
    fileInput.onchange = () => {
      const f = fileInput.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = e => {
        item.img = e.target.result;
        
        // C·∫≠p nh·∫≠t l·∫°i HTML c·ªßa thumbnail sau khi t·∫£i ·∫£nh
        thumb.innerHTML = 
          `<img src="${item.img}" alt="thumb" style="cursor: pointer;" title="D√πng n√∫t 'M·ªü ·∫£nh' b√™n d∆∞·ªõi ƒë·ªÉ xem.">`;

        const data = load();
        const idx = data.findIndex(x=>x.id===item.id);
        if(idx>-1){ data[idx]=item; localSave(data); toast('ƒê√£ l∆∞u ·∫£nh'); }
      };
      reader.readAsDataURL(f);
    };
    
    // LOGIC M·ªöI: M·ªü ·∫£nh trong tab m·ªõi b·∫±ng Object URL
    btnOpenImg.onclick = () => {
      if(!item.img) { toast('Kh√¥ng c√≥ ·∫£nh ƒë·ªÉ m·ªü.'); return; }
      
      try {
        // 1. Convert Base64 sang Blob
        const blob = base64ToBlob(item.img);
        
        // 2. T·∫°o Object URL ng·∫Øn g·ªçn
        const url = URL.createObjectURL(blob);
        
        // 3. M·ªü Object URL trong tab m·ªõi
        window.open(url, '_blank');
        
        // 4. D·ªçn d·∫πp (Gi·∫£i ph√≥ng b·ªô nh·ªõ sau 1s)
        setTimeout(() => { URL.revokeObjectURL(url); }, 1000); 

        toast('ƒê√£ m·ªü ·∫£nh trong Tab m·ªõi. (S·ª≠ d·ª•ng Object URL)');
      } catch (e) {
        toast('‚ùå L·ªói m·ªü ·∫£nh: D·ªØ li·ªáu Base64 b·ªã h·ªèng ho·∫∑c qu√° l·ªõn.');
        console.error("L·ªói khi m·ªü ·∫£nh Base64:", e);
      }
    };

    // Remove image
    btnRemoveImg.onclick = () => {
      if(!item.img) return;
      if(!confirm('X√≥a ·∫£nh?')) return;
      item.img = null;
      thumb.innerHTML = `<div style="color:var(--muted);padding:8px">Ch∆∞a c√≥ ·∫£nh</div>`;
      const data = load();
      const idx = data.findIndex(x=>x.id===item.id);
      if(idx>-1){ data[idx]=item; localSave(data); toast('·∫¢nh ƒë√£ x√≥a'); }
    };

    // Save
    btnSave.onclick = () => {
      item.note = note.innerText.trim();
      item.date = new Date().toISOString().slice(0,10);
      const data = load();
      const idx = data.findIndex(x=>x.id===item.id);
      if(idx>-1) data[idx]=item; else data.push(item);
      save(data);
      toast('ƒê√£ l∆∞u');
    };

    // Auto-save on blur
    note.addEventListener('blur', ()=>{
      item.note = note.innerText.trim();
      const data = load();
      const idx = data.findIndex(x=>x.id===item.id);
      if(idx>-1){ data[idx]=item; localSave(data); }
    });

    return div;
  }

  // Render all
  function renderAll(){
    grid.innerHTML='';
    const data = load();
    emptyMsg.style.display = data.length ? 'none':'block';
    data.forEach(item => grid.appendChild(renderBox(item)));
  }

  // Add box
  document.getElementById('add-box').onclick = ()=>{
    const data = load();
    const item = {
      id: uid(),
      title: "S∆° ƒë·ªì " + (data.length+1),
      note: "",
      img: null,
      date: new Date().toISOString().slice(0,10)
    };
    data.unshift(item);
    save(data);
    toast('ƒê√£ th√™m √¥');
  };

  // Clear all
  document.getElementById('clear-all').onclick = ()=>{
    if(!confirm('X√≥a to√†n b·ªô √¥?')) return;
    localStorage.removeItem(KEY);
    renderAll();
    toast('ƒê√£ x√≥a to√†n b·ªô');
  };

  // Export
  document.getElementById('export-all').onclick = ()=>{
    const data = load();
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'mindmap_grid_export.json';
    a.click();
  };

  // Import
  document.getElementById('import-file').onchange = e=>{
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ev=>{
      try{
        const parsed = JSON.parse(ev.target.result);
        if(!Array.isArray(parsed)) throw new Error("File JSON kh√¥ng h·ª£p l·ªá");
        localSave(parsed);
        renderAll();
        toast('ƒê√£ nh·∫≠p d·ªØ li·ªáu');
      }catch(err){
        alert('Import l·ªói: ' + err.message);
      }
    };
    r.readAsText(f);
    e.target.value = "";
  };

  // Toast
  function toast(t){
    const el = document.createElement('div');
    el.style.position='fixed';
    el.style.right='16px';
    el.style.top='16px';
    el.style.background='#13202b';
    el.style.color='var(--text)';
    el.style.padding='10px 14px';
    el.style.borderRadius='10px';
    el.style.boxShadow='0 6px 16px rgba(0,0,0,0.6)';
    el.style.zIndex=9999;
    el.className='__toast';
    el.innerText = t;
    document.body.appendChild(el);
    setTimeout(()=>{ el.remove(); }, 2600);
  }

  // Init
  renderAll();

})();
// ------------------ Ch·ª©c nƒÉng chuy·ªÉn trang ƒë·ªìng nh·∫•t ------------------

// H√†m m·ªõi ƒë·ªÉ x·ª≠ l√Ω chuy·ªÉn trang c√≥ hi·ªáu ·ª©ng
function navigate(url) {
  // 1. K√≠ch ho·∫°t hi·ªáu ·ª©ng fade-out/overlay (400ms)
  document.body.classList.add('is-leaving');
  
  // 2. Ch·ªù 400ms (ph·∫£i kh·ªõp v·ªõi CSS transition) r·ªìi chuy·ªÉn trang
  setTimeout(() => {
    window.location.href = url;
  }, 400); 
}

// X·ª≠ l√Ω hi·ªáu ·ª©ng Fade In khi trang M·ªöI T·∫¢I XONG
document.addEventListener('DOMContentLoaded', () => {
  // ƒê·∫£m b·∫£o l·ªõp ph·ªß chuy·ªÉn trang bi·∫øn m·∫•t (Fade In)
  document.body.classList.remove('is-leaving');
});

// ---------------------------------------------------------------------
</script>
<div style="margin-top:30px;">
    <button class="btn" onclick="window.location.href='index.html'">
      ‚Üê Quay l·∫°i G√≥c h·ªçc t·∫≠p
    </button>
</div>
</body>
</html>
